{% extends 'base.html.twig' %}

{% block title %}BOR TERMINAL{% endblock %}

{% block body %}
    <div class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0">Market Summary</h2>
            <div>
                <span id="elapsed-time" class="text-muted me-3 small"></span>
                <button id="refresh-summary" class="btn btn-outline-primary">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="summary-spinner"></span>
                    Refresh
                </button>
            </div>
        </div>

        <div id="market-summary-container">
            <div class="alert alert-info">Loading market summary...</div>
        </div>
    </div>

    <script>
        let timerInterval;
        let startTime;

        function startTimer() {
            startTime = new Date();
            $('#elapsed-time').text('Loading... 0s');

            timerInterval = setInterval(function () {
                const now = new Date();
                const seconds = Math.floor((now - startTime) / 1000);
                $('#elapsed-time').text(`Loading... ${seconds}s`);
            }, 500);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            const endTime = new Date();
            const seconds = ((endTime - startTime) / 1000).toFixed(1);
            $('#elapsed-time').text(`Loaded in ${seconds}s`);
        }

        function loadMarketSummary() {
            $('#summary-spinner').removeClass('d-none');
            $('#refresh-summary').attr('disabled', true);
            $('#market-summary-container').html('<div class="alert alert-info">Fetching data...</div>');

            startTimer();

            $.ajax({
                url: '{{ path("api_market_summary_json") }}',
                method: 'GET',
                success: function (response) {
                    $('#market-summary-container').html(response.html_result);
                },
                error: function (xhr) {
                    $('#market-summary-container').html(
                        '<div class="alert alert-danger">Error loading market summary: ' + (xhr.responseJSON?.error || 'Unknown error') + '</div>'
                    );
                },
                complete: function () {
                    stopTimer();
                    $('#summary-spinner').addClass('d-none');
                    $('#refresh-summary').attr('disabled', false);
                }
            });
        }

        $(document).ready(function () {
            loadMarketSummary();

            $('#refresh-summary').click(function () {
                loadMarketSummary();
            });
        });
    </script>

{% endblock %}
